<div class="register-container">
    <div class="register-card">
        <div class="logo">
            <img src="assets/images/logo.png" alt="QuinuAI Logo">
        </div>
        
        <!-- Indicador de progreso -->
        <div class="progress-bar">
            <div class="progress-step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
                <div class="step-number">1</div>
                <div class="step-label">Cuenta</div>
            </div>
            <div class="progress-connector" [class.active]="currentStep > 1"></div>
            <div class="progress-step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
                <div class="step-number">2</div>
                <div class="step-label">Datos personales</div>
            </div>
            <div class="progress-connector" [class.active]="currentStep > 2"></div>
            <div class="progress-step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
                <div class="step-number">3</div>
                <div class="step-label">Personalizaci√≥n</div>
            </div>
            <div class="progress-connector" [class.active]="currentStep > 3"></div>
            <div class="progress-step" [class.active]="currentStep >= 4">
                <div class="step-number">4</div>
                <div class="step-label">Ubicaci√≥n y Objetivos</div>
            </div>
        </div>
        
        <form [formGroup]="registerForm" class="register-form">
            <!-- Paso 1: Datos de cuenta -->
            <div *ngIf="currentStep === 1" class="step-content" formGroupName="cuenta">
                <h2>Crea tu cuenta</h2>
                
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Email</mat-label>
                    <input matInput type="email" formControlName="email" placeholder="ejemplo@email.com">
                    <mat-icon matSuffix>email</mat-icon>
                    <mat-error *ngIf="registerForm.get('cuenta.email')?.hasError('required')">
                        Email es requerido
                    </mat-error>
                    <mat-error *ngIf="registerForm.get('cuenta.email')?.hasError('email')">
                        Ingresa un email v√°lido
                    </mat-error>
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Contrase√±a</mat-label>
                    <input matInput type="password" formControlName="password">
                    <mat-icon matSuffix>lock</mat-icon>
                    <mat-error *ngIf="registerForm.get('cuenta.password')?.hasError('required')">
                        Contrase√±a es requerida
                    </mat-error>
                    <mat-error *ngIf="registerForm.get('cuenta.password')?.hasError('minlength')">
                        La contrase√±a debe tener al menos 6 caracteres
                    </mat-error>
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Confirmar contrase√±a</mat-label>
                    <input matInput type="password" formControlName="confirmPassword">
                    <mat-icon matSuffix>lock</mat-icon>
                    <mat-error *ngIf="registerForm.get('cuenta.confirmPassword')?.hasError('required')">
                        Confirma tu contrase√±a
                    </mat-error>
                </mat-form-field>
                
                <!-- Selecci√≥n de tipo de registro -->
                <div class="registration-type">
                    <h3>¬øPara qui√©n usar√°s QuinuAI?</h3>
                    
                    <div class="type-selection">
                        <mat-card class="type-option" [class.selected]="registrationType === 'individual'" (click)="cambiarTipoRegistro('individual')">
                            <mat-icon>person</mat-icon>
                            <span>Para m√≠</span>
                            <p>Crea un plan nutricional personal seg√∫n tus necesidades</p>
                        </mat-card>
                        
                        <mat-card class="type-option" [class.selected]="registrationType === 'familiar'" (click)="cambiarTipoRegistro('familiar')">
                            <mat-icon>family_restroom</mat-icon>
                            <span>Para mi familia</span>
                            <p>Gestiona planes nutricionales para toda tu familia</p>
                        </mat-card>
                    </div>
                </div>
            </div>
            
            <!-- Paso 2: Datos personales -->
            <div *ngIf="currentStep === 2" class="step-content">
                <!-- Registro Individual -->
                <div *ngIf="registrationType === 'individual'" formGroupName="datosPersonales">
                    <h2>Tus datos personales</h2>
                    
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Nombre completo</mat-label>
                        <input matInput formControlName="nombre" placeholder="Tu nombre y apellidos">
                        <mat-error *ngIf="registerForm.get('datosPersonales.nombre')?.invalid">
                            Nombre es requerido
                        </mat-error>
                    </mat-form-field>
                    
                    <div class="form-row">
                        <mat-form-field appearance="outline">
                            <mat-label>Fecha de nacimiento</mat-label>
                            <input matInput [matDatepicker]="picker" formControlName="fechaNacimiento">
                            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>
                            <mat-error *ngIf="registerForm.get('datosPersonales.fechaNacimiento')?.invalid">
                                Fecha de nacimiento requerida
                            </mat-error>
                        </mat-form-field>
                        
                        <mat-form-field appearance="outline">
                            <mat-label>Sexo</mat-label>
                            <mat-select formControlName="sexo">
                                <mat-option value="masculino">Masculino</mat-option>
                                <mat-option value="femenino">Femenino</mat-option>
                            </mat-select>
                            <mat-error *ngIf="registerForm.get('datosPersonales.sexo')?.invalid">
                                Selecciona tu sexo
                            </mat-error>
                        </mat-form-field>
                    </div>
                    
                    <div class="form-row">
                        <mat-form-field appearance="outline">
                            <mat-label>Peso (kg)</mat-label>
                            <input matInput type="number" formControlName="pesoKg" min="1">
                            <mat-error *ngIf="registerForm.get('datosPersonales.pesoKg')?.invalid">
                                Ingresa un peso v√°lido
                            </mat-error>
                        </mat-form-field>
                        
                        <mat-form-field appearance="outline">
                            <mat-label>Altura (cm)</mat-label>
                            <input matInput type="number" formControlName="alturaCm" min="1">
                            <mat-error *ngIf="registerForm.get('datosPersonales.alturaCm')?.invalid">
                                Ingresa una altura v√°lida
                            </mat-error>
                        </mat-form-field>
                    </div>
                    
                    <!-- Alergias, disgustos y condiciones m√©dicas -->
                    <div class="health-section">
                        <h3>Alergias alimenticias</h3>
                        <div class="tags-selector">
                            <div class="common-tags">
                                <span class="tag-pill" *ngFor="let allergy of allergyOptions" (click)="agregarAlergia(allergy.name)">
                                    <span class="tag-icon">{{allergy.icon}}</span> {{allergy.name}}
                                </span>
                            </div>
                        </div>
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Alergias (separadas por coma)</mat-label>
                            <input matInput placeholder="Ej: gluten, l√°cteos, frutos secos" #alergiasInput>
                            <button mat-icon-button matSuffix (click)="agregarAlergia(alergiasInput.value); alergiasInput.value=''">
                                <mat-icon>add</mat-icon>
                            </button>
                        </mat-form-field>
                        
                        <div class="chips-container" *ngIf="alergias.length > 0">
                            <div class="chip" *ngFor="let alergia of alergias; let i = index">
                                {{alergia}}
                                <button mat-icon-button (click)="eliminarAlergia(i)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="health-section">
                        <h3>Disgustos alimenticios</h3>
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Alimentos que no te gustan</mat-label>
                            <input matInput placeholder="Ej: berenjena, br√≥coli" #disgustosInput>
                            <button mat-icon-button matSuffix (click)="agregarDisgusto(disgustosInput.value); disgustosInput.value=''">
                                <mat-icon>add</mat-icon>
                            </button>
                        </mat-form-field>
                        
                        <div class="chips-container" *ngIf="disgustos.length > 0">
                            <div class="chip" *ngFor="let disgusto of disgustos; let i = index">
                                {{disgusto}}
                                <button mat-icon-button (click)="eliminarDisgusto(i)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="health-section">
                        <h3>
                            <mat-icon>medical_services</mat-icon>
                            Condiciones m√©dicas
                        </h3>
                        <p class="section-description">
                            Selecciona las condiciones m√©dicas que debemos tener en cuenta para tus recomendaciones
                            <mat-icon matTooltip="Esta informaci√≥n es importante para adaptar tu plan nutricional" class="info-icon">info</mat-icon>
                        </p>
                        
                        <div class="health-conditions">
                            <div class="condition-card" 
                                 *ngFor="let condition of healthConditionOptions" 
                                 [class.selected]="isConditionSelected(condition.name)"
                                 (click)="toggleHealthCondition(condition.name)">
                                <div class="condition-icon">{{condition.icon}}</div>
                                <div class="condition-name">{{condition.name}}</div>
                                <div class="condition-checkbox">
                                    <mat-icon *ngIf="isConditionSelected(condition.name)">check_circle</mat-icon>
                                </div>
                            </div>
                        </div>
                        
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Otras condiciones m√©dicas</mat-label>
                            <textarea matInput placeholder="Ej: artritis, osteoporosis, etc." #condicionesInput></textarea>
                            <button mat-icon-button matSuffix (click)="agregarCondicionMedica(condicionesInput.value); condicionesInput.value=''">
                                <mat-icon>add</mat-icon>
                            </button>
                            <mat-hint>Ingresa otras condiciones m√©dicas y presiona el bot√≥n + para a√±adirlas</mat-hint>
                        </mat-form-field>
                        
                        <div class="chips-container" *ngIf="condicionesMedicas.length > 0">
                            <div class="chip" *ngFor="let condicion of condicionesMedicas; let i = index">
                                {{condicion}}
                                <button mat-icon-button (click)="eliminarCondicionMedica(i)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Registro Familiar -->
                <div *ngIf="registrationType === 'familiar'" class="family-registration">
                    <h2>Informaci√≥n familiar</h2>
                    <p class="instruction">Comienza por tus datos y luego a√±ade a los miembros de tu familia</p>
                    
                    <div class="family-container">
                        <!-- Sidebar de miembros -->
                        <div class="family-sidebar">
                            <button mat-raised-button color="primary" class="add-member-btn" (click)="agregarMiembroFamiliar()">
                                <mat-icon>person_add</mat-icon> A√±adir miembro
                            </button>
                            
                            <div class="members-list">
                                <mat-card class="member-card" 
                                          [class.active]="currentMemberIndex === -1" 
                                          (click)="seleccionarMiembro(-1)">
                                    <mat-icon>person</mat-icon>
                                    <span>T√∫ (Principal)</span>
                                </mat-card>
                                
                                <mat-card *ngFor="let member of familyMembers; let i = index" 
                                          class="member-card" 
                                          [class.active]="currentMemberIndex === i" 
                                          (click)="seleccionarMiembro(i)">
                                    <mat-icon>person</mat-icon>
                                    <span>{{member.nombre || 'Miembro ' + (i+1)}}</span>
                                    <button mat-icon-button class="remove-btn" (click)="eliminarMiembroFamiliar(i); $event.stopPropagation()">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </mat-card>
                            </div>
                        </div>
                        
                        <!-- Formulario del miembro seleccionado -->
                        <div class="member-form">
                            <!-- Datos del usuario principal -->
                            <div *ngIf="currentMemberIndex === -1" formGroupName="datosPersonales">
                                <h3>Tus datos (Usuario principal)</h3>
                                
                                <!-- Formulario igual que para registro individual -->
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Nombre completo</mat-label>
                                    <input matInput formControlName="nombre" placeholder="Tu nombre y apellidos">
                                </mat-form-field>
                                
                                <div class="form-row">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Fecha de nacimiento</mat-label>
                                        <input matInput [matDatepicker]="pickerPrincipal" formControlName="fechaNacimiento">
                                        <mat-datepicker-toggle matIconSuffix [for]="pickerPrincipal"></mat-datepicker-toggle>
                                        <mat-datepicker #pickerPrincipal></mat-datepicker>
                                    </mat-form-field>
                                    
                                    <mat-form-field appearance="outline">
                                        <mat-label>Sexo</mat-label>
                                        <mat-select formControlName="sexo">
                                            <mat-option value="masculino">Masculino</mat-option>
                                            <mat-option value="femenino">Femenino</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                
                                <div class="form-row">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Peso (kg)</mat-label>
                                        <input matInput type="number" formControlName="pesoKg" min="1">
                                    </mat-form-field>
                                    
                                    <mat-form-field appearance="outline">
                                        <mat-label>Altura (cm)</mat-label>
                                        <input matInput type="number" formControlName="alturaCm" min="1">
                                    </mat-form-field>
                                </div>
                                
                                <!-- Resto de campos igual que en el registro individual -->
                                <div class="health-section">
                                    <h3>Alergias alimenticias</h3>
                                    <div class="tags-selector">
                                        <div class="common-tags">
                                            <span class="tag-pill" *ngFor="let allergy of allergyOptions" (click)="agregarAlergia(allergy.name)">
                                                <span class="tag-icon">{{allergy.icon}}</span> {{allergy.name}}
                                            </span>
                                        </div>
                                    </div>
                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Alergias (separadas por coma)</mat-label>
                                        <input matInput placeholder="Ej: gluten, l√°cteos, frutos secos" #alergiasInput>
                                        <button mat-icon-button matSuffix (click)="agregarAlergia(alergiasInput.value); alergiasInput.value=''">
                                            <mat-icon>add</mat-icon>
                                        </button>
                                    </mat-form-field>
                                    
                                    <div class="chips-container" *ngIf="alergias.length > 0">
                                        <div class="chip" *ngFor="let alergia of alergias; let i = index">
                                            {{alergia}}
                                            <button mat-icon-button (click)="eliminarAlergia(i)">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="health-section">
                                    <h3>Disgustos alimenticios</h3>
                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Alimentos que no te gustan</mat-label>
                                        <input matInput placeholder="Ej: berenjena, br√≥coli" #disgustosInput>
                                        <button mat-icon-button matSuffix (click)="agregarDisgusto(disgustosInput.value); disgustosInput.value=''">
                                            <mat-icon>add</mat-icon>
                                        </button>
                                    </mat-form-field>
                                    
                                    <div class="chips-container" *ngIf="disgustos.length > 0">
                                        <div class="chip" *ngFor="let disgusto of disgustos; let i = index">
                                            {{disgusto}}
                                            <button mat-icon-button (click)="eliminarDisgusto(i)">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="health-section">
                                    <h3>
                                        <mat-icon>medical_services</mat-icon>
                                        Condiciones m√©dicas
                                    </h3>
                                    <p class="section-description">
                                        Selecciona las condiciones m√©dicas que debemos tener en cuenta para tus recomendaciones
                                        <mat-icon matTooltip="Esta informaci√≥n es importante para adaptar tu plan nutricional" class="info-icon">info</mat-icon>
                                    </p>
                                    
                                    <div class="health-conditions">
                                        <div class="condition-card" 
                                             *ngFor="let condition of healthConditionOptions" 
                                             [class.selected]="isConditionSelected(condition.name)"
                                             (click)="toggleHealthCondition(condition.name)">
                                            <div class="condition-icon">{{condition.icon}}</div>
                                            <div class="condition-name">{{condition.name}}</div>
                                            <div class="condition-checkbox">
                                                <mat-icon *ngIf="isConditionSelected(condition.name)">check_circle</mat-icon>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Otras condiciones m√©dicas</mat-label>
                                        <textarea matInput placeholder="Ej: artritis, osteoporosis, etc." #condicionesInput></textarea>
                                        <button mat-icon-button matSuffix (click)="agregarCondicionMedica(condicionesInput.value); condicionesInput.value=''">
                                            <mat-icon>add</mat-icon>
                                        </button>
                                        <mat-hint>Ingresa otras condiciones m√©dicas y presiona el bot√≥n + para a√±adirlas</mat-hint>
                                    </mat-form-field>
                                    
                                    <div class="chips-container" *ngIf="condicionesMedicas.length > 0">
                                        <div class="chip" *ngFor="let condicion of condicionesMedicas; let i = index">
                                            {{condicion}}
                                            <button mat-icon-button (click)="eliminarCondicionMedica(i)">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Datos de miembros familiares -->
                            <div *ngIf="currentMemberIndex >= 0" [formGroupName]="'miembrosFamilia'" class="family-member-details">
                                <div [formGroupName]="currentMemberIndex">
                                    <h3>Datos de miembro familiar</h3>
                                    
                                    <!-- Formulario para miembro familiar -->
                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Nombre completo</mat-label>
                                        <input matInput formControlName="nombre" placeholder="Nombre y apellidos">
                                        <mat-error *ngIf="registerForm.get('miembrosFamilia.'+currentMemberIndex+'.nombre')?.invalid">
                                            Nombre es requerido
                                        </mat-error>
                                    </mat-form-field>
                                    
                                    <div class="form-row">
                                        <mat-form-field appearance="outline">
                                            <mat-label>Fecha de nacimiento</mat-label>
                                            <input matInput [matDatepicker]="familyPicker" formControlName="fechaNacimiento">
                                            <mat-datepicker-toggle matIconSuffix [for]="familyPicker"></mat-datepicker-toggle>
                                            <mat-datepicker #familyPicker></mat-datepicker>
                                            <mat-error *ngIf="registerForm.get('miembrosFamilia.'+currentMemberIndex+'.fechaNacimiento')?.invalid">
                                                Fecha de nacimiento requerida
                                            </mat-error>
                                        </mat-form-field>
                                        
                                        <mat-form-field appearance="outline">
                                            <mat-label>Sexo</mat-label>
                                            <mat-select formControlName="sexo">
                                                <mat-option value="masculino">Masculino</mat-option>
                                                <mat-option value="femenino">Femenino</mat-option>
                                            </mat-select>
                                            <mat-error *ngIf="registerForm.get('miembrosFamilia.'+currentMemberIndex+'.sexo')?.invalid">
                                                Selecciona el sexo
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    
                                    <div class="form-row">
                                        <mat-form-field appearance="outline">
                                            <mat-label>Peso (kg)</mat-label>
                                            <input matInput type="number" formControlName="pesoKg" min="1">
                                            <mat-error *ngIf="registerForm.get('miembrosFamilia.'+currentMemberIndex+'.pesoKg')?.invalid">
                                                Ingresa un peso v√°lido
                                            </mat-error>
                                        </mat-form-field>
                                        
                                        <mat-form-field appearance="outline">
                                            <mat-label>Altura (cm)</mat-label>
                                            <input matInput type="number" formControlName="alturaCm" min="1">
                                            <mat-error *ngIf="registerForm.get('miembrosFamilia.'+currentMemberIndex+'.alturaCm')?.invalid">
                                                Ingresa una altura v√°lida
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    
                                    <!-- Alergias, disgustos y condiciones m√©dicas -->
                                    <div class="health-section">
                                        <h3>Alergias alimenticias</h3>
                                        <div class="tags-selector">
                                            <div class="common-tags">
                                                <span class="tag-pill" *ngFor="let allergy of allergyOptions" (click)="agregarAlergia(allergy.name)">
                                                    <span class="tag-icon">{{allergy.icon}}</span> {{allergy.name}}
                                                </span>
                                            </div>
                                        </div>
                                        <mat-form-field appearance="outline" class="full-width">
                                            <mat-label>Alergias (separadas por coma)</mat-label>
                                            <input matInput placeholder="Ej: gluten, l√°cteos, frutos secos" #alergiasInput>
                                            <button mat-icon-button matSuffix (click)="agregarAlergia(alergiasInput.value); alergiasInput.value=''">
                                                <mat-icon>add</mat-icon>
                                            </button>
                                        </mat-form-field>
                                        
                                        <div class="chips-container" *ngIf="alergias.length > 0">
                                            <div class="chip" *ngFor="let alergia of alergias; let i = index">
                                                {{alergia}}
                                                <button mat-icon-button (click)="eliminarAlergia(i)">
                                                    <mat-icon>close</mat-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="health-section">
                                        <h3>Disgustos alimenticios</h3>
                                        <mat-form-field appearance="outline" class="full-width">
                                            <mat-label>Alimentos que no te gustan</mat-label>
                                            <input matInput placeholder="Ej: berenjena, br√≥coli" #disgustosInput>
                                            <button mat-icon-button matSuffix (click)="agregarDisgusto(disgustosInput.value); disgustosInput.value=''">
                                                <mat-icon>add</mat-icon>
                                            </button>
                                        </mat-form-field>
                                        
                                        <div class="chips-container" *ngIf="disgustos.length > 0">
                                            <div class="chip" *ngFor="let disgusto of disgustos; let i = index">
                                                {{disgusto}}
                                                <button mat-icon-button (click)="eliminarDisgusto(i)">
                                                    <mat-icon>close</mat-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="health-section">
                                        <h3>
                                            <mat-icon>medical_services</mat-icon>
                                            Condiciones m√©dicas
                                        </h3>
                                        <p class="section-description">
                                            Selecciona las condiciones m√©dicas que debemos tener en cuenta para tus recomendaciones
                                            <mat-icon matTooltip="Esta informaci√≥n es importante para adaptar tu plan nutricional" class="info-icon">info</mat-icon>
                                        </p>
                                        
                                        <div class="health-conditions">
                                            <div class="condition-card" 
                                                 *ngFor="let condition of healthConditionOptions" 
                                                 [class.selected]="isConditionSelected(condition.name)"
                                                 (click)="toggleHealthCondition(condition.name)">
                                                <div class="condition-icon">{{condition.icon}}</div>
                                                <div class="condition-name">{{condition.name}}</div>
                                                <div class="condition-checkbox">
                                                    <mat-icon *ngIf="isConditionSelected(condition.name)">check_circle</mat-icon>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <mat-form-field appearance="outline" class="full-width">
                                            <mat-label>Otras condiciones m√©dicas</mat-label>
                                            <textarea matInput placeholder="Ej: artritis, osteoporosis, etc." #condicionesInput></textarea>
                                            <button mat-icon-button matSuffix (click)="agregarCondicionMedica(condicionesInput.value); condicionesInput.value=''">
                                                <mat-icon>add</mat-icon>
                                            </button>
                                            <mat-hint>Ingresa otras condiciones m√©dicas y presiona el bot√≥n + para a√±adirlas</mat-hint>
                                        </mat-form-field>
                                        
                                        <div class="chips-container" *ngIf="condicionesMedicas.length > 0">
                                            <div class="chip" *ngFor="let condicion of condicionesMedicas; let i = index">
                                                {{condicion}}
                                                <button mat-icon-button (click)="eliminarCondicionMedica(i)">
                                                    <mat-icon>close</mat-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Paso 3: Personalizaci√≥n de alimentos -->
            <div *ngIf="currentStep === 3" class="step-content">
                <h2>Personaliza tu experiencia alimenticia</h2>
                
                <div formGroupName="preferenciasPresupuesto">
                    <!-- Secci√≥n de presupuesto -->
                    <div class="budget-section">
                        <h3>
                            <mat-icon>{{icons.budget}}</mat-icon>
                            Presupuesto para alimentaci√≥n
                        </h3>
                        <p class="section-description">
                            Ay√∫danos a optimizar tus comidas de acuerdo a tu presupuesto
                            <mat-icon [matTooltip]="helpMessages.budget" class="info-icon">info</mat-icon>
                        </p>
                        
                        <div class="budget-sliders">
                            <div class="slider-container">
                                <label>Presupuesto mensual total (S/.)</label>
                                <div class="slider-visual">
                                    <div class="slider-icon">üí∞</div>
                                    <mat-slider min="0" max="2000" step="50" class="full-width">
                                        <input matSliderThumb [value]="presupuestoTotalValue" (valueChange)="updatePresupuestoTotal($event)">
                                    </mat-slider>
                                    <div class="input-number-container">
                                        <input type="number" min="0" max="2000" step="50" 
                                               [value]="presupuestoTotalValue"
                                               (input)="onPresupuestoTotalInput($event)"
                                               class="budget-input">
                                    </div>
                                </div>
                                <div class="slider-value">S/. {{presupuestoTotalValue | number:'1.2-2'}}</div>
                            </div>
                            
                            <div class="slider-container">
                                <label>Presupuesto diario por persona (S/.)</label>
                                <div class="slider-visual">
                                    <div class="slider-icon">üçΩÔ∏è</div>
                                    <mat-slider min="0" max="100" step="5" class="full-width">
                                        <input matSliderThumb [value]="presupuestoDiarioValue" (valueChange)="updatePresupuestoDiario($event)">
                                    </mat-slider>
                                    <div class="input-number-container">
                                        <input type="number" min="0" max="100" step="5" 
                                               [value]="presupuestoDiarioValue"
                                               (input)="onPresupuestoDiarioInput($event)"
                                               class="budget-input">
                                    </div>
                                </div>
                                <div class="slider-value">S/. {{presupuestoDiarioValue | number:'1.2-2'}}</div>
                            </div>
                        </div>
                    </div>
                    
                    <mat-divider></mat-divider>
                    
                    <!-- Secci√≥n de comidas del d√≠a -->
                    <div class="meals-section">
                        <h3>
                            <mat-icon>{{icons.meals}}</mat-icon>
                            Comidas del d√≠a
                        </h3>
                        <p class="section-description">
                            Selecciona las comidas que realizas habitualmente
                            <mat-icon [matTooltip]="tooltips.meals" class="info-icon">info</mat-icon>
                        </p>
                        
                        <div class="meals-selection">
                            <div *ngFor="let comida of comidasDelDia; let i = index" 
                                 class="meal-chip" 
                                 [class.selected]="comida.selected"
                                 (click)="toggleComida(i)">
                                <mat-icon *ngIf="comida.selected">check</mat-icon>
                                {{comida.name}}
                            </div>
                        </div>
                    </div>
                    
                    <mat-divider></mat-divider>
                    
                    <!-- Secci√≥n de platos favoritos -->
                    <div class="favorites-section">
                        <h3>
                            <mat-icon>{{icons.favorites}}</mat-icon>
                            Tus platos favoritos
                        </h3>
                        <p class="section-description">
                            Cu√©ntanos qu√© te gusta comer para personalizar tus recomendaciones
                            <mat-icon [matTooltip]="tooltips.favorites" class="info-icon">info</mat-icon>
                        </p>
                        
                        <div class="tags-selector">
                            <div class="common-tags">
                                <span class="tag-pill" *ngFor="let dish of favoriteDishOptions" 
                                      (click)="agregarPlatoFavoritoConIcono(dish.name, dish.icon)">
                                    <span class="tag-icon">{{dish.icon}}</span> {{dish.name}}
                                </span>
                            </div>
                        </div>
                        
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>A√±ade tus platos favoritos</mat-label>
                            <input matInput placeholder="Ej: Pollo al horno, lomo saltado" #platosInput>
                            <button mat-icon-button matSuffix (click)="agregarPlatoFavorito(platosInput.value); platosInput.value=''">
                                <mat-icon>add</mat-icon>
                            </button>
                        </mat-form-field>
                        
                        <div class="chips-container favorite-chips" *ngIf="platosFavoritos.length > 0">
                            <div class="chip" *ngFor="let plato of platosFavoritos; let i = index">
                                {{plato}}
                                <button mat-icon-button (click)="eliminarPlatoFavorito(i)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <mat-divider></mat-divider>
                    
                    <!-- Secci√≥n de h√°bitos alimenticios -->
                    <div class="habits-section">
                        <h3>
                            <mat-icon>restaurant</mat-icon>
                            H√°bitos alimenticios
                        </h3>
                        <p class="section-description">
                            Esta informaci√≥n nos ayuda a entender mejor tus necesidades espec√≠ficas
                            <mat-icon [matTooltip]="tooltips.habits" class="info-icon">info</mat-icon>
                        </p>
                        
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Describe brevemente c√≥mo te alimentas habitualmente</mat-label>
                            <textarea matInput formControlName="descripcionAlimentacion" 
                                      placeholder="Ej: Desayuno liviano, almuerzo abundante, cena temprano, etc."></textarea>
                            <mat-icon matSuffix>description</mat-icon>
                        </mat-form-field>
                        
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>¬øTienes limitaciones de horarios para comer?</mat-label>
                            <input matInput formControlName="limitacionesHorario" 
                                   placeholder="Ej: Solo tengo 30 min para almorzar en el trabajo">
                            <mat-icon matSuffix>schedule</mat-icon>
                        </mat-form-field>
                        
                        <div class="checkbox-option">
                            <mat-checkbox formControlName="comidaFueraDeCasa">
                                Habitualmente como fuera de casa
                            </mat-checkbox>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paso 4: Ubicaci√≥n y Objetivos -->
            <div *ngIf="currentStep === 4" class="step-content" formGroupName="ubicacionObjetivos">
                <h2>Ubicaci√≥n y Objetivos</h2>
                
                <!-- Secci√≥n de ubicaci√≥n -->
                <div formGroupName="ubicacion" class="location-section">
                    <h3>
                        <mat-icon>{{icons.location}}</mat-icon>
                        Tu ubicaci√≥n
                    </h3>
                    <p class="section-description">
                        Esta informaci√≥n nos ayuda a personalizar tus recomendaciones alimenticias
                        <mat-icon [matTooltip]="helpMessages.location" class="info-icon">info</mat-icon>
                    </p>

                    <div class="location-inputs">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Pa√≠s</mat-label>
                            <mat-select formControlName="pais" (selectionChange)="onPaisChange($event.value)">
                                <mat-option *ngFor="let pais of paises" [value]="pais">
                                    {{pais}}
                                </mat-option>
                            </mat-select>
                            <mat-icon matSuffix>public</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Ciudad</mat-label>
                            <mat-select formControlName="ciudad" (selectionChange)="onCiudadChange($event.value)" [disabled]="!ciudadesDisponibles.length">
                                <mat-option *ngFor="let ciudad of ciudadesDisponibles" [value]="ciudad">
                                    {{ciudad}}
                                </mat-option>
                            </mat-select>
                            <mat-icon matSuffix>location_city</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Regi√≥n/Distrito</mat-label>
                            <mat-select formControlName="region" [disabled]="!distritosDisponibles.length">
                                <mat-option *ngFor="let distrito of distritosDisponibles" [value]="distrito">
                                    {{distrito}}
                                </mat-option>
                            </mat-select>
                            <mat-icon matSuffix>place</mat-icon>
                            <!-- Si no hay distritos disponibles, permitir entrada manual -->
                            <input matInput *ngIf="!distritosDisponibles.length" formControlName="region" 
                                   placeholder="Ingresa tu distrito o regi√≥n">
                        </mat-form-field>
                    </div>
                </div>

                <!-- Secci√≥n de actividad f√≠sica y objetivos -->
                <div formGroupName="objetivos">
                    <div class="activity-options">
                        <h3>
                            <mat-icon>{{icons.activity}}</mat-icon>
                            Nivel de actividad f√≠sica
                        </h3>
                        <p class="section-description">
                            Esto nos ayuda a calcular tus necesidades cal√≥ricas diarias
                            <mat-icon [matTooltip]="helpMessages.activity" class="info-icon">info</mat-icon>
                        </p>

                        <div class="activity-buttons">
                            <div class="activity-button" [class.selected]="registerForm.get('ubicacionObjetivos.objetivos.actividadFisica')?.value === 'baja'"
                                 (click)="registerForm.get('ubicacionObjetivos.objetivos.actividadFisica')?.setValue('baja')">
                                <mat-icon>accessible</mat-icon>
                                <span>Baja</span>
                                <small>Principalmente sedentario</small>
                            </div>
                            
                            <div class="activity-button" [class.selected]="registerForm.get('ubicacionObjetivos.objetivos.actividadFisica')?.value === 'moderada'"
                                 (click)="registerForm.get('ubicacionObjetivos.objetivos.actividadFisica')?.setValue('moderada')">
                                <mat-icon>directions_walk</mat-icon>
                                <span>Moderada</span>
                                <small>Ejercicio 1-3 d√≠as/semana</small>
                            </div>
                            
                            <div class="activity-button" [class.selected]="registerForm.get('ubicacionObjetivos.objetivos.actividadFisica')?.value === 'alta'"
                                 (click)="registerForm.get('ubicacionObjetivos.objetivos.actividadFisica')?.setValue('alta')">
                                <mat-icon>directions_run</mat-icon>
                                <span>Alta</span>
                                <small>Ejercicio 3-5 d√≠as/semana</small>
                            </div>
                            
                            <div class="activity-button" [class.selected]="registerForm.get('ubicacionObjetivos.objetivos.actividadFisica')?.value === 'muy alta'"
                                 (click)="registerForm.get('ubicacionObjetivos.objetivos.actividadFisica')?.setValue('muy alta')">
                                <mat-icon>fitness_center</mat-icon>
                                <span>Muy Alta</span>
                                <small>Ejercicio 6-7 d√≠as/semana</small>
                            </div>
                        </div>
                    </div>

                    <div class="goals-options">
                        <h3>
                            <mat-icon>{{icons.goals}}</mat-icon>
                            Objetivo principal
                        </h3>
                        <p class="section-description">
                            Selecciona tu objetivo principal para personalizar tus recomendaciones
                        </p>

                        <div class="goals-buttons">
                            <div class="goal-button" [class.selected]="registerForm.get('ubicacionObjetivos.objetivos.objetivo')?.value === 'mantener peso'"
                                 (click)="registerForm.get('ubicacionObjetivos.objetivos.objetivo')?.setValue('mantener peso')">
                                <mat-icon>balance</mat-icon>
                                <span>Mantener Peso</span>
                                <small>Nutrici√≥n equilibrada</small>
                            </div>
                            
                            <div class="goal-button" [class.selected]="registerForm.get('ubicacionObjetivos.objetivos.objetivo')?.value === 'perder peso'"
                                 (click)="registerForm.get('ubicacionObjetivos.objetivos.objetivo')?.setValue('perder peso')">
                                <mat-icon>trending_down</mat-icon>
                                <span>Perder Peso</span>
                                <small>Control cal√≥rico</small>
                            </div>
                            
                            <div class="goal-button" [class.selected]="registerForm.get('ubicacionObjetivos.objetivos.objetivo')?.value === 'ganar masa'"
                                 (click)="registerForm.get('ubicacionObjetivos.objetivos.objetivo')?.setValue('ganar masa')">
                                <mat-icon>trending_up</mat-icon>
                                <span>Ganar Masa</span>
                                <small>Alto valor proteico</small>
                            </div>
                            
                            <div class="goal-button" [class.selected]="registerForm.get('ubicacionObjetivos.objetivos.objetivo')?.value === 'mejorar salud'"
                                 (click)="registerForm.get('ubicacionObjetivos.objetivos.objetivo')?.setValue('mejorar salud')">
                                <mat-icon>favorite</mat-icon>
                                <span>Mejorar Salud</span>
                                <small>Nutrientes esenciales</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Botones de navegaci√≥n -->
            <div class="navigation-buttons">
                <button mat-button *ngIf="currentStep > 1" type="button" (click)="pasoPrevio()">
                    <mat-icon>arrow_back</mat-icon> Anterior
                </button>
                
                <button mat-raised-button color="primary" type="button" *ngIf="currentStep < totalSteps" (click)="siguientePaso()" [disabled]="!validarPasoActual()">
                    Siguiente <mat-icon>arrow_forward</mat-icon>
                </button>
                
                <button mat-raised-button color="primary" type="button" *ngIf="currentStep === totalSteps" (click)="finalizar()" [disabled]="!validarPasoActual()">
                    Finalizar registro
                </button>
            </div>
        </form>
    </div>
</div>

<!-- A√±adir animaci√≥n de confetti para finalizaci√≥n -->
<div class="confetti-container" *ngIf="showConfetti">
    <div class="confetti" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]"></div>
</div>
